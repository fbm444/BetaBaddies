name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_ENV: production

jobs:
  test:
    name: Run Tests Before Deployment
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ats_tracker_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Setup test database from schema dump
        working-directory: ./backend
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: ats_tracker_test
          DB_USER: postgres
          DB_PASS: postgres
        run: |
          echo "üìä Creating test database from schema dump..."
          PGPASSWORD=postgres psql -h localhost -U postgres -c "DROP DATABASE IF EXISTS ats_tracker_test;"
          PGPASSWORD=postgres psql -h localhost -U postgres -c "CREATE DATABASE ats_tracker_test;"
          PGPASSWORD=postgres psql -h localhost -U postgres -d ats_tracker_test -f ../db/sprint_4/database_schema_dump.sql
          echo "‚úÖ Database schema created successfully"

      - name: Run backend tests
        working-directory: ./backend
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: ats_tracker_test
          DB_USER: postgres
          DB_PASS: postgres
          SERVER_PORT: 3001
          NODE_ENV: development
          SESSION_SECRET: test-secret-key
          FRONTEND_URL: http://localhost:3000
          BACKEND_URL: http://localhost:3001
          CORS_ORIGIN: http://localhost:3000
          CLOUD_PROVIDER: local
          UPLOAD_MAX_SIZE: 10mb
          CI: true
          SHOW_TEST_OUTPUT: true
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -o pipefail
          npm run test:all 2>&1 | tee test-output.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Tests failed with exit code $TEST_EXIT_CODE"
            exit $TEST_EXIT_CODE
          fi

  deploy-frontend:
    name: Deploy Frontend to Vercel (Production)
    needs: test
    runs-on: ubuntu-latest
    if: success()
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel (Production)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod"
          # Don't use working-directory - let Vercel use its Root Directory setting (frontend/ats-tracker)

  notify:
    name: Send Deployment Notification
    needs: [deploy-frontend]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Install AWS CLI
        run: |
          if ! command -v aws &> /dev/null; then
            echo "üì¶ Installing AWS CLI..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install
            rm -rf aws awscliv2.zip
            echo "‚úÖ AWS CLI installed"
          else
            echo "‚úÖ AWS CLI already installed"
          fi
          # Verify AWS CLI is accessible
          aws --version || echo "‚ö†Ô∏è AWS CLI not found in PATH"
          which aws || echo "‚ö†Ô∏è AWS CLI path not found"

      - name: Publish to SNS Topic for Email Notification
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_ID }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION || 'us-east-2' }}
          SNS_TOPIC_ARN: ${{ secrets.AWS_SNS_TOPIC_ARN }}
        run: |
          echo "üîç Debugging SNS configuration..."
          echo "AWS_ACCESS_KEY_ID is set: $([ -n "$AWS_ACCESS_KEY_ID" ] && echo 'YES' || echo 'NO')"
          echo "AWS_SECRET_ACCESS_KEY is set: $([ -n "$AWS_SECRET_ACCESS_KEY" ] && echo 'YES' || echo 'NO')"
          echo "SNS_TOPIC_ARN is set: $([ -n "$SNS_TOPIC_ARN" ] && echo 'YES' || echo 'NO')"
          echo "SNS_TOPIC_ARN value: ${SNS_TOPIC_ARN:0:50}..." # Show first 50 chars

          # Check if credentials are configured
          if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ] || [ -z "$SNS_TOPIC_ARN" ]; then
            echo "‚ö†Ô∏è SNS notification skipped - AWS credentials or topic ARN not configured"
            echo "To enable email notifications via SNS, set these secrets:"
            echo "  - AWS_ACCESS_KEY_ID"
            echo "  - AWS_SECRET_ACCESS_KEY_ID"
            echo "  - AWS_SNS_TOPIC_ARN (ARN of your SNS topic with email subscriptions)"
            exit 0
          fi

          echo "‚úÖ AWS credentials configured"
          echo "üìç Region: $AWS_DEFAULT_REGION"
          echo "üìß SNS Topic ARN: $SNS_TOPIC_ARN"

          # Verify AWS CLI is available and working
          echo "üîç Checking AWS CLI..."
          if aws --version; then
            echo "‚úÖ AWS CLI is available"
          else
            echo "‚ùå AWS CLI version check failed"
            exit 0  # Skip notification if AWS CLI is broken
          fi

          # Test AWS credentials
          echo "üîç Testing AWS credentials..."
          IDENTITY_OUTPUT=$(aws sts get-caller-identity --region "$AWS_DEFAULT_REGION" 2>&1)
          IDENTITY_EXIT=$?
          if [ $IDENTITY_EXIT -eq 0 ]; then
            echo "‚úÖ AWS credentials are valid"
            echo "Identity: $IDENTITY_OUTPUT"
          else
            echo "‚ùå AWS credentials test failed (exit code: $IDENTITY_EXIT)"
            echo "Error: $IDENTITY_OUTPUT"
            echo "‚ö†Ô∏è Skipping SNS notification due to credential failure"
            exit 0
          fi

          STATUS="${{ job.status }}"
          EMOJI=""
          case "$STATUS" in
            success)
              EMOJI="‚úÖ"
              ;;
            failure)
              EMOJI="‚ùå"
              ;;
            cancelled)
              EMOJI="‚ö†Ô∏è"
              ;;
            *)
              EMOJI="‚ÑπÔ∏è"
              ;;
          esac

          # Create email message
          SUBJECT="${EMOJI} Production Deployment ${STATUS}: ${{ github.repository }}"

          # Build message body using printf for proper newline handling
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          BODY=$(printf "Deployment Status: %s\n\nRepository: %s\nBranch: %s\nCommit: %s\nAuthor: %s\nWorkflow: %s\nRun ID: %s\nTimestamp: %s\n\nView deployment: %s/%s/actions/runs/%s" \
            "${STATUS}" \
            "${{ github.repository }}" \
            "${{ github.ref_name }}" \
            "${COMMIT_SHORT}" \
            "${{ github.actor }}" \
            "${{ github.workflow }}" \
            "${{ github.run_id }}" \
            "$(date -u +'%Y-%m-%d %H:%M:%S UTC')" \
            "${{ github.server_url }}" \
            "${{ github.repository }}" \
            "${{ github.run_id }}")

          echo "üìß Publishing to SNS topic..."
          echo "üìù Subject: $SUBJECT"
          echo "üìÑ Message preview (first 200 chars): ${BODY:0:200}..."

          # Publish to SNS topic with error handling
          echo "üîç Running AWS SNS publish command..."
          echo "Region: $AWS_DEFAULT_REGION"
          echo "Topic ARN: $SNS_TOPIC_ARN"

          OUTPUT=$(aws sns publish \
            --region "$AWS_DEFAULT_REGION" \
            --topic-arn "$SNS_TOPIC_ARN" \
            --subject "$SUBJECT" \
            --message "$BODY" 2>&1)

          EXIT_CODE=$?

          if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Message published to SNS topic successfully"
            echo "Response: $OUTPUT"
          else
            echo "‚ùå Failed to publish to SNS topic"
            echo "Exit code: $EXIT_CODE"
            echo "Error output: $OUTPUT"
            echo ""
            echo "üîç Troubleshooting exit code $EXIT_CODE:"
            echo "  - Exit code 254 usually means authentication/permission issue"
            echo "  - Verify IAM user has 'sns:Publish' permission"
            echo "  - Check if topic ARN is correct: $SNS_TOPIC_ARN"
            echo "  - Verify region matches topic region: $AWS_DEFAULT_REGION"
            echo "  - Ensure credentials are valid and not expired"
            echo "‚ö†Ô∏è Continuing anyway (notification is non-blocking)"
          fi
        continue-on-error: true

  # notify:
  #   name: Send Deployment Notification
  #   needs: [deploy-frontend]
  #   runs-on: ubuntu-latest
  #   if: always()
  #
  #   steps:
  #     - name: Send SMS notification via SNS
  #       env:
  #         AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION || 'us-east-2' }}
  #         PHONE_NUMBER: ${{ secrets.AWS_SNS_PHONE_NUMBER }}
  #       run: |
  #         # Check if credentials are configured
  #         if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ] || [ -z "$PHONE_NUMBER" ]; then
  #           echo "‚ö†Ô∏è SMS notification skipped - AWS credentials or phone number not configured"
  #           echo "To enable SMS notifications, set these secrets:"
  #           echo "  - AWS_ACCESS_KEY_ID"
  #           echo "  - AWS_SECRET_ACCESS_KEY"
  #           echo "  - AWS_SNS_PHONE_NUMBER"
  #           exit 0
  #         fi
  #
  #         # Verify AWS CLI is available
  #         if ! command -v aws &> /dev/null; then
  #           echo "‚ö†Ô∏è AWS CLI is not installed - skipping SMS notification"
  #           exit 0
  #         fi
  #
  #         echo "‚úÖ AWS credentials configured"
  #         echo "üìç Region: $AWS_DEFAULT_REGION"
  #
  #         STATUS="${{ job.status }}"
  #         EMOJI=""
  #         case "$STATUS" in
  #           success)
  #             EMOJI="‚úÖ"
  #             ;;
  #           failure)
  #             EMOJI="‚ùå"
  #             ;;
  #           cancelled)
  #             EMOJI="‚ö†Ô∏è"
  #             ;;
  #           *)
  #             EMOJI="‚ÑπÔ∏è"
  #             ;;
  #         esac
  #
  #         MESSAGE="${EMOJI} Deployment ${STATUS}: ${{ github.repository }} - Branch: ${{ github.ref_name }} - Commit: ${GITHUB_SHA:0:7}"
  #
  #         # Truncate to 160 characters (SMS limit)
  #         MESSAGE="${MESSAGE:0:160}"
  #
  #         echo "üì± Sending SMS..."
  #         echo "üìù Message: $MESSAGE"
  #
  #         aws sns publish \
  #           --region "$AWS_DEFAULT_REGION" \
  #           --phone-number "$PHONE_NUMBER" \
  #           --message "$MESSAGE" \
  #           --message-attributes '{"AWS.SNS.SMS.SMSType":{"DataType":"String","StringValue":"Transactional"}}' \
  #           && echo "‚úÖ SMS sent successfully" \
  #           || echo "‚ö†Ô∏è Failed to send SMS - continuing anyway"
  #       if: always()
  #       continue-on-error: true
  #
  #     - name: Send email notification via SES
  #       env:
  #         AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION || 'us-east-2' }}
  #         SES_FROM_EMAIL: ${{ secrets.SES_FROM_EMAIL }}
  #         SES_TO_EMAIL: ${{ secrets.SES_TO_EMAIL }}
  #       run: |
  #         # Check if credentials are configured
  #         if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ] || [ -z "$SES_FROM_EMAIL" ] || [ -z "$SES_TO_EMAIL" ]; then
  #           echo "‚ö†Ô∏è Email notification skipped - AWS credentials or email addresses not configured"
  #           echo "To enable email notifications, set these secrets:"
  #           echo "  - AWS_ACCESS_KEY_ID"
  #           echo "  - AWS_SECRET_ACCESS_KEY"
  #           echo "  - SES_FROM_EMAIL (verified sender email in SES)"
  #           echo "  - SES_TO_EMAIL (recipient email)"
  #           exit 0
  #         fi
  #
  #         # Verify AWS CLI is available
  #         if ! command -v aws &> /dev/null; then
  #           echo "‚ö†Ô∏è AWS CLI is not installed - skipping email notification"
  #           exit 0
  #         fi
  #
  #         STATUS="${{ job.status }}"
  #         EMOJI=""
  #         case "$STATUS" in
  #           success)
  #             EMOJI="‚úÖ"
  #             ;;
  #           failure)
  #             EMOJI="‚ùå"
  #             ;;
  #           cancelled)
  #             EMOJI="‚ö†Ô∏è"
  #             ;;
  #           *)
  #             EMOJI="‚ÑπÔ∏è"
  #             ;;
  #         esac
  #
  #         SUBJECT="${EMOJI} Deployment ${STATUS}: ${{ github.repository }}"
  #
  #         BODY="Deployment Status: ${STATUS}
  #
  # Repository: ${{ github.repository }}
  # Branch: ${{ github.ref_name }}
  # Commit: ${GITHUB_SHA:0:7}
  # Author: ${{ github.actor }}
  # Workflow: ${{ github.workflow }}
  # Run ID: ${{ github.run_id }}
  #
  # View deployment: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
  #
  #         echo "üìß Sending email notification..."
  #         echo "üì§ From: $SES_FROM_EMAIL"
  #         echo "üì• To: $SES_TO_EMAIL"
  #
  #         # Create temporary file for email body
  #         BODY_FILE=$(mktemp)
  #         echo "$BODY" > "$BODY_FILE"
  #
  #         aws ses send-email \
  #           --region "$AWS_DEFAULT_REGION" \
  #           --source "$SES_FROM_EMAIL" \
  #           --destination "ToAddresses=$SES_TO_EMAIL" \
  #           --message "Subject={Data='$SUBJECT',Charset=UTF-8},Body={Text={Data=file://$BODY_FILE,Charset=UTF-8}}" \
  #           && echo "‚úÖ Email sent successfully" \
  #           || echo "‚ö†Ô∏è Failed to send email - continuing anyway"
  #
  #         rm -f "$BODY_FILE"
  #       if: always()
  #       continue-on-error: true
  #
  #     - name: Create GitHub deployment
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           github.rest.repos.createDeployment({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             ref: context.sha,
  #             environment: 'production',
  #             auto_merge: false,
  #             required_contexts: []
  #           })
