name: Publish to AWS SNS Topic

on:
  workflow_run:
    workflows: ["Deploy to Production"]
    types: [completed]

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_SNS_TOPIC_ARN: ${{ secrets.AWS_SNS_TOPIC_ARN }}

jobs:
  publish-to-sns:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Only run if triggered manually OR if the deployment workflow completed successfully
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Check if SNS is configured
        id: check-sns
        run: |
          if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ] || [ -z "$AWS_SNS_TOPIC_ARN" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è SNS notification skipped - AWS credentials or topic ARN not configured"
            echo "To enable SNS notifications, set these secrets:"
            echo "  - AWS_ACCESS_KEY_ID"
            echo "  - AWS_SECRET_ACCESS_KEY"
            echo "  - AWS_REGION"
            echo "  - AWS_SNS_TOPIC_ARN"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "‚úÖ SNS configuration found"
          fi

      - name: Configure AWS credentials
        if: steps.check-sns.outputs.configured == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Publish to AWS SNS Topic
        if: steps.check-sns.outputs.configured == 'true'
        env:
          AWS_SNS_TOPIC_ARN: ${{ secrets.AWS_SNS_TOPIC_ARN }}
          WORKFLOW_STATUS: ${{ github.event.workflow_run.conclusion || 'success' }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name || 'Manual Trigger' }}
          COMMIT_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}
          COMMIT_MESSAGE: ${{ github.event.workflow_run.head_commit.message || github.event.head_commit.message || 'Manual test notification' }}
          ACTOR: ${{ github.event.workflow_run.actor.login || github.actor }}
          BRANCH: ${{ github.event.workflow_run.head_branch || github.ref_name }}
          RUN_ID: ${{ github.event.workflow_run.id || github.run_id }}
          WORKFLOW_RUN_URL: ${{ github.event.workflow_run.html_url }}
          REPOSITORY: ${{ github.repository }}
          SERVER_URL: ${{ github.server_url }}
          CURRENT_RUN_ID: ${{ github.run_id }}
        run: |
          # Determine status emoji and color
          if [ "$WORKFLOW_STATUS" = "success" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="SUCCESS"
            STATUS_COLOR="green"
          elif [ "$WORKFLOW_STATUS" = "failure" ]; then
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="FAILED"
            STATUS_COLOR="red"
          elif [ "$WORKFLOW_STATUS" = "cancelled" ]; then
            STATUS_EMOJI="‚ö†Ô∏è"
            STATUS_TEXT="CANCELLED"
            STATUS_COLOR="yellow"
          else
            STATUS_EMOJI="‚ÑπÔ∏è"
            STATUS_TEXT="$WORKFLOW_STATUS"
            STATUS_COLOR="blue"
          fi

          # Format commit message (first line only, max 100 chars)
          COMMIT_MSG_SHORT=$(echo "$COMMIT_MESSAGE" | head -n 1 | cut -c1-100)
          COMMIT_SHORT=$(echo "$COMMIT_SHA" | cut -c1-7)

          # Set RUN_URL based on trigger type
          if [ -n "$WORKFLOW_RUN_URL" ]; then
            RUN_URL="$WORKFLOW_RUN_URL"
          else
            RUN_URL="${SERVER_URL}/${REPOSITORY}/actions/runs/${CURRENT_RUN_ID}"
          fi

          # Create plain text email message
          MESSAGE_BODY=$(cat <<EOF
${STATUS_EMOJI} Production Deployment ${STATUS_TEXT}

Repository: ${REPOSITORY}
Branch: ${BRANCH}
Workflow: ${WORKFLOW_NAME}

Commit: ${COMMIT_SHORT}
Message: ${COMMIT_MSG_SHORT}
Author: ${ACTOR}

Status: ${STATUS_TEXT}
Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

View Deployment: ${RUN_URL}

---
This is an automated notification from GitHub Actions.
EOF
          )

          # Create subject line
          SUBJECT="${STATUS_EMOJI} Production Deployment ${STATUS_TEXT}: ${REPOSITORY} - ${BRANCH}"

          # Publish to SNS with plain text message
          echo "üìß Publishing to SNS topic: $AWS_SNS_TOPIC_ARN"
          echo "Subject: $SUBJECT"

          OUTPUT=$(aws sns publish \
            --topic-arn "$AWS_SNS_TOPIC_ARN" \
            --subject "$SUBJECT" \
            --message "$MESSAGE_BODY" 2>&1)

          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Message published to SNS topic successfully"
            echo "Response: $OUTPUT"
          else
            echo "‚ùå Failed to publish to SNS topic"
            echo "Exit code: $EXIT_CODE"
            echo "Error: $OUTPUT"
            # Don't fail the workflow if SNS publish fails
            exit 0
          fi
