name: Publish to AWS SNS Topic

on:
  workflow_run:
    workflows: ["Deploy Production"]
    types: [completed]

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_SNS_TOPIC_ARN: ${{ secrets.AWS_SNS_TOPIC_ARN }}

jobs:
  publish-to-sns:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Only run if the deployment workflow completed (success or failure)
    if: github.event.workflow_run.conclusion != ''

    steps:
      - name: Check if SNS is configured
        id: check-sns
        run: |
          if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ] || [ -z "$AWS_SNS_TOPIC_ARN" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è SNS notification skipped - AWS credentials or topic ARN not configured"
            echo "To enable SNS notifications, set these secrets:"
            echo "  - AWS_ACCESS_KEY_ID"
            echo "  - AWS_SECRET_ACCESS_KEY"
            echo "  - AWS_REGION"
            echo "  - AWS_SNS_TOPIC_ARN"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "‚úÖ SNS configuration found"
          fi

      - name: Configure AWS credentials
        if: steps.check-sns.outputs.configured == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Publish to AWS SNS Topic
        if: steps.check-sns.outputs.configured == 'true'
        env:
          AWS_SNS_TOPIC_ARN: ${{ secrets.AWS_SNS_TOPIC_ARN }}
          WORKFLOW_STATUS: ${{ github.event.workflow_run.conclusion }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
          COMMIT_MESSAGE: ${{ github.event.workflow_run.head_commit.message }}
          ACTOR: ${{ github.event.workflow_run.actor.login }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          RUN_URL: ${{ github.event.workflow_run.html_url }}
          REPOSITORY: ${{ github.repository }}
        run: |
          # Determine status emoji and color
          if [ "$WORKFLOW_STATUS" = "success" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="SUCCESS"
            STATUS_COLOR="green"
          elif [ "$WORKFLOW_STATUS" = "failure" ]; then
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="FAILED"
            STATUS_COLOR="red"
          elif [ "$WORKFLOW_STATUS" = "cancelled" ]; then
            STATUS_EMOJI="‚ö†Ô∏è"
            STATUS_TEXT="CANCELLED"
            STATUS_COLOR="yellow"
          else
            STATUS_EMOJI="‚ÑπÔ∏è"
            STATUS_TEXT="$WORKFLOW_STATUS"
            STATUS_COLOR="blue"
          fi

          # Format commit message (first line only, max 100 chars)
          COMMIT_MSG_SHORT=$(echo "$COMMIT_MESSAGE" | head -n 1 | cut -c1-100)
          COMMIT_SHORT=$(echo "$COMMIT_SHA" | cut -c1-7)

          # Create email-friendly plain text message
          EMAIL_BODY=$(cat <<EOF
          ${STATUS_EMOJI} Production Deployment ${STATUS_TEXT}

          Repository: ${REPOSITORY}
          Branch: ${BRANCH}
          Workflow: ${WORKFLOW_NAME}

          Commit: ${COMMIT_SHORT}
          Message: ${COMMIT_MSG_SHORT}
          Author: ${ACTOR}

          Status: ${STATUS_TEXT}
          Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          View Deployment: ${RUN_URL}

          ---
          This is an automated notification from GitHub Actions.
          EOF
          )

          # Create HTML message for better email formatting
          HTML_BODY=$(cat <<EOF
          <html>
          <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
            <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
              <h2 style="color: #${STATUS_COLOR}; border-bottom: 2px solid #${STATUS_COLOR}; padding-bottom: 10px;">
                ${STATUS_EMOJI} Production Deployment ${STATUS_TEXT}
              </h2>
              
              <div style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0;">
                <table style="width: 100%; border-collapse: collapse;">
                  <tr>
                    <td style="padding: 8px 0; font-weight: bold; width: 140px;">Repository:</td>
                    <td style="padding: 8px 0;">${REPOSITORY}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; font-weight: bold;">Branch:</td>
                    <td style="padding: 8px 0;"><strong>${BRANCH}</strong></td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; font-weight: bold;">Workflow:</td>
                    <td style="padding: 8px 0;">${WORKFLOW_NAME}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; font-weight: bold;">Commit:</td>
                    <td style="padding: 8px 0;"><code style="background-color: #e8e8e8; padding: 2px 6px; border-radius: 3px;">${COMMIT_SHORT}</code></td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; font-weight: bold;">Message:</td>
                    <td style="padding: 8px 0;">${COMMIT_MSG_SHORT}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; font-weight: bold;">Author:</td>
                    <td style="padding: 8px 0;">${ACTOR}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; font-weight: bold;">Status:</td>
                    <td style="padding: 8px 0;"><strong style="color: #${STATUS_COLOR};">${STATUS_TEXT}</strong></td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; font-weight: bold;">Timestamp:</td>
                    <td style="padding: 8px 0;">$(date -u +'%Y-%m-%d %H:%M:%S UTC')</td>
                  </tr>
                </table>
              </div>
              
              <div style="text-align: center; margin: 30px 0;">
                <a href="${RUN_URL}" style="background-color: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block;">
                  View Deployment Details
                </a>
              </div>
              
              <hr style="border: none; border-top: 1px solid #ddd; margin: 30px 0;">
              <p style="color: #666; font-size: 12px; text-align: center;">
                This is an automated notification from GitHub Actions.
              </p>
            </div>
          </body>
          </html>
          EOF
          )

          # Create subject line
          SUBJECT="${STATUS_EMOJI} Production Deployment ${STATUS_TEXT}: ${REPOSITORY} - ${BRANCH}"

          # Publish to SNS with HTML email body
          # SNS email subscriptions will render HTML automatically
          echo "üìß Publishing to SNS topic: $AWS_SNS_TOPIC_ARN"
          echo "Subject: $SUBJECT"

          OUTPUT=$(aws sns publish \
            --topic-arn "$AWS_SNS_TOPIC_ARN" \
            --subject "$SUBJECT" \
            --message "$HTML_BODY" 2>&1)

          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Message published to SNS topic successfully"
            echo "Response: $OUTPUT"
          else
            echo "‚ùå Failed to publish to SNS topic"
            echo "Exit code: $EXIT_CODE"
            echo "Error: $OUTPUT"
            # Don't fail the workflow if SNS publish fails
            exit 0
          fi
