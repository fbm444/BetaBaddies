name: Publish to AWS SNS Topic

on:
  push:
    branches: [main, production]

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_SNS_TOPIC_ARN: ${{ secrets.AWS_SNS_TOPIC_ARN }}
  MESSAGE: ${{ toJSON(github) }}

jobs:
  publish-to-sns:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Check if SNS is configured
        id: check-sns
        run: |
          if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ] || [ -z "$AWS_SNS_TOPIC_ARN" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è SNS notification skipped - AWS credentials or topic ARN not configured"
            echo "To enable SNS notifications, set these secrets:"
            echo "  - AWS_ACCESS_KEY_ID"
            echo "  - AWS_SECRET_ACCESS_KEY"
            echo "  - AWS_REGION"
            echo "  - AWS_SNS_TOPIC_ARN"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
            echo "‚úÖ SNS configuration found"
          fi

      - name: Configure AWS credentials
        if: steps.check-sns.outputs.configured == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Publish to AWS SNS Topic
        if: steps.check-sns.outputs.configured == 'true'
        env:
          AWS_SNS_TOPIC_ARN: ${{ secrets.AWS_SNS_TOPIC_ARN }}
        run: |
          # Create message payload
          MESSAGE=$(cat <<EOF
          {
            "event": "${{ github.event_name }}",
            "repository": "${{ github.repository }}",
            "ref": "${{ github.ref }}",
            "workflow": "${{ github.workflow }}",
            "run_id": "${{ github.run_id }}",
            "actor": "${{ github.actor }}",
            "commit": "${{ github.sha }}",
            "commit_message": "${{ github.event.head_commit.message }}",
            "branch": "${{ github.ref_name }}",
            "status": "${{ job.status }}",
            "timestamp": "${{ github.event.head_commit.timestamp }}",
            "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          )

          # Publish to SNS
          echo "üìß Publishing to SNS topic: $AWS_SNS_TOPIC_ARN"
          OUTPUT=$(aws sns publish \
            --topic-arn "$AWS_SNS_TOPIC_ARN" \
            --subject "üöÄ Deployment: ${{ github.repository }} - ${{ github.ref_name }}" \
            --message "$MESSAGE" 2>&1)

          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Message published to SNS topic successfully"
            echo "Response: $OUTPUT"
          else
            echo "‚ùå Failed to publish to SNS topic"
            echo "Exit code: $EXIT_CODE"
            echo "Error: $OUTPUT"
            exit $EXIT_CODE
          fi
