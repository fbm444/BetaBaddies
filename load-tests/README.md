# Load Testing with k6

This directory contains load testing scripts using [k6](https://k6.io/), a modern load testing tool.

## Prerequisites

### Install k6

**macOS:**
```bash
brew install k6
```

**Linux:**
```bash
sudo gpg -k
sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6
```

**Windows:**
```powershell
choco install k6
```

Or download from: https://k6.io/docs/getting-started/installation/

### Create Test User

Before running tests, create a test user in your database:

**Option 1: Use the script (Recommended)**
```bash
cd backend
node scripts/createLoadTestUser.js
```

**Option 2: Use registration endpoint**
```bash
curl -X POST http://localhost:3001/api/v1/users/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "loadtest@example.com",
    "password": "LoadTest123!"
  }'
```

**Option 3: Manual SQL (requires bcrypt hash)**
```sql
-- You'll need to hash the password first using bcrypt
-- Use the script instead for easier setup
```

## Configuration

Set environment variables (optional):

```bash
export API_URL="http://localhost:3001/api/v1"
export TEST_USER_EMAIL="loadtest@example.com"
export TEST_USER_PASSWORD="LoadTest123!"
```

## Running Tests

### Verify Login First

Before running load tests, verify login works:

```bash
k6 run test-login.js
```

This will test:
- User authentication
- Session cookie extraction
- Authenticated API access

### Run All Tests

```bash
chmod +x run-load-tests.sh
./run-load-tests.sh
```

### Run Individual Tests

**API Endpoints Test (50-100 concurrent users):**
```bash
k6 run api-endpoints.test.js
```

**Database Performance Test:**
```bash
k6 run database-performance.test.js
```

**File Upload/Download Test:**
```bash
k6 run file-upload-download.test.js
```

**Full Load Test (comprehensive user journey):**
```bash
k6 run full-load.test.js
```

### Run with Custom Configuration

```bash
API_URL="http://localhost:3001/api/v1" \
TEST_USER_EMAIL="your-test@email.com" \
TEST_USER_PASSWORD="YourPassword123!" \
k6 run full-load.test.js
```

## Test Scenarios

### 1. API Endpoints Test (`api-endpoints.test.js`)

- **Load Pattern**: Ramps from 25 → 50 → 75 → 100 concurrent users
- **Duration**: ~10 minutes
- **Tests**: Main API endpoints (profile, jobs, interviews, etc.)
- **Metrics**: Response times, error rates, throughput

### 2. Database Performance Test (`database-performance.test.js`)

- **Load Pattern**: Ramps from 20 → 50 → 75 concurrent users
- **Duration**: ~7 minutes
- **Tests**: Database-heavy endpoints (analytics, statistics, searches)
- **Metrics**: Query performance, slow query detection

### 3. File Upload/Download Test (`file-upload-download.test.js`)

- **Load Pattern**: Ramps from 10 → 25 → 50 concurrent users
- **Duration**: ~7 minutes
- **Tests**: File upload, download, list operations
- **Metrics**: Upload/download times, file size handling

### 4. Full Load Test (`full-load.test.js`)

- **Load Pattern**: Ramps from 25 → 50 → 75 → 100 concurrent users
- **Duration**: ~17 minutes
- **Tests**: Complete user journeys (dashboard → profile → jobs → interviews)
- **Metrics**: End-to-end journey times, page load times

## Performance Thresholds

All tests have performance thresholds:

- **HTTP Request Duration**: 95% of requests < 500ms, 99% < 1000ms
- **Error Rate**: < 1% of requests should fail
- **Database Queries**: 95% < 500ms, 99% < 1000ms
- **File Operations**: Uploads < 3s (P95), Downloads < 1s (P95)

## Results and Reports

Test results are saved to `load-test-results/` directory:

- **JSON**: Detailed metrics in JSON format
- **CSV**: Time-series data for analysis
- **HTML**: Visual reports (generated by some tests)
- **Logs**: Console output and errors

### Viewing Results

**JSON Results:**
```bash
cat load-test-results/api-endpoints_*.json | jq '.metrics'
```

**CSV Results:**
Open in Excel, Google Sheets, or use Python/R for analysis

**HTML Reports:**
Open `load-test-results/*.html` in a web browser

## Interpreting Results

### Key Metrics

1. **http_req_duration**: Request duration (avg, min, max, percentiles)
2. **http_req_failed**: Failed request rate
3. **http_reqs**: Total requests and requests per second
4. **iteration_duration**: Time for complete test iterations
5. **data_received/sent**: Network throughput

### Performance Indicators

✅ **Good Performance:**
- P95 response time < 500ms
- Error rate < 1%
- Consistent throughput under load

⚠️ **Needs Attention:**
- P95 response time > 1000ms
- Error rate > 5%
- Throughput degradation under load

❌ **Poor Performance:**
- P95 response time > 2000ms
- Error rate > 10%
- Application becomes unresponsive

## Troubleshooting

### Test User Authentication Fails

1. Verify test user exists in database
2. Check password is correct
3. Ensure user account is active

### High Error Rates

1. Check backend logs for errors
2. Verify database connection pool settings
3. Check for rate limiting issues
4. Monitor server resources (CPU, memory)

### Slow Response Times

1. Check database query performance
2. Verify indexes are in place
3. Monitor database connection pool
4. Check for N+1 query problems
5. Review server resource usage

### File Upload/Download Failures

1. Verify file upload directory permissions
2. Check file size limits
3. Verify multer configuration
4. Check disk space availability

## Continuous Integration

Add to CI/CD pipeline:

```yaml
# Example GitHub Actions
- name: Run Load Tests
  run: |
    cd load-tests
    chmod +x run-load-tests.sh
    ./run-load-tests.sh
```

## Best Practices

1. **Run tests in staging environment** (not production)
2. **Start with lower load** and gradually increase
3. **Monitor server resources** during tests
4. **Compare results** across test runs
5. **Fix issues** before increasing load
6. **Document baseline** performance metrics

## Additional Resources

- [k6 Documentation](https://k6.io/docs/)
- [k6 Examples](https://k6.io/docs/examples/)
- [Performance Testing Best Practices](https://k6.io/docs/test-types/load-testing/)

